// background.js
// İçerik scriptinden gelen zafiyetleri saklar ve popup'a sunar.

let storedVulnerabilities = []; // arka planda saklanan son sonuç

// İçerik scriptinden gelirse kaydet
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  try {
    if (!message || !message.action) return;

    if (message.action === 'vulnerabilitiesDetected') {
      // içerik scripti doğrudan tarama sonuçlarını gönderiyor
      storedVulnerabilities = Array.isArray(message.vulnerabilities) ? message.vulnerabilities : [];
      // popup veya diğer isteklere bilgi vermek isterseniz runtime mesajı yayınlayabilirsiniz
      // chrome.runtime.sendMessage({ action: 'vulnsUpdated', vulnerabilities: storedVulnerabilities });
      sendResponse({ status: 'ok' });
      return true;
    }

    // popup'tan veya başka bir yerden "getVulns" isteği
    if (message.action === 'getVulns') {
      sendResponse({ vulnerabilities: storedVulnerabilities || [] });
      return true;
    }

    // popup'tan sayfaya tara komutu buradan yönlendirilmeyecek (popup doğrudan tab'a gönderir)
    // Ama eğer popup taramaya başladıktan sonra background üzerinden beklemek isterseniz mantık ekleyebilirsiniz.

  } catch (e) {
    console.error('background onMessage error', e);
  }
});
