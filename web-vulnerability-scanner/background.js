// Background script - uzantının arka planda çalışan kısmı

// Uzantı yüklendiğinde çalışacak kod
chrome.runtime.onInstalled.addListener(function() {
  console.log('Web Güvenlik Tarayıcısı yüklendi');
  
  // İlk kurulumda varsayılan ayarları belirle
  chrome.storage.local.set({
    scanOnPageLoad: false,  // Sayfa yüklendiğinde otomatik tarama yapma ayarı
    notificationsEnabled: true  // Bildirim gösterme ayarı
  });
});

// Content script ve popup arasında iletişimi sağlayan mesaj dinleyicisi
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
  // Content script'ten gelen açıklık tespiti mesajını işle
  if (request.action === "vulnerabilitiesDetected") {
    // Açıklıkları sakla
    chrome.storage.local.set({
      lastScanResults: request.vulnerabilities,
      lastScanTime: new Date().toISOString()
    });
    
    // Açıklık sayısını kontrol et
    const vulnerabilityCount = request.vulnerabilities.length;
    
    // Bildirim gösterme ayarını kontrol et
    chrome.storage.local.get('notificationsEnabled', function(data) {
      if (data.notificationsEnabled && vulnerabilityCount > 0) {
        // Kullanıcıya bildirim göster
        chrome.notifications.create({
          type: 'basic',
          iconUrl: 'images/icon128.png',
          title: 'Güvenlik Açıkları Tespit Edildi',
          message: `${vulnerabilityCount} adet potansiyel güvenlik açığı bulundu.`,
          priority: 2
        });
      }
    });
    
    // Popup açıksa, açıklık bilgilerini popup'a ilet
    chrome.runtime.sendMessage({
      action: "vulnerabilitiesDetected",
      vulnerabilities: request.vulnerabilities
    });
  }
});